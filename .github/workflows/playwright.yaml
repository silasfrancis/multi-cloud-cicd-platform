name: Run playwright e2e tests

on:
  workflow_run:
    workflows:
      - Build and Push Docker Images
    types:
      - completed
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-24.04
    if: |
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'

    env:
      DBNAME: postgres
      DBUSER: postgres
      PASSWORD: ${{ secrets.DB_PASSWORD }}
      POSTGRES_PORT: 5432
      CLIENT_HOST: 0.0.0.0
      CLIENT_PORT: 3000
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      CHOKIDAR_USEPOLLING: "true"

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3

      - name: Start stack with Docker Compose
        uses: hoverkraft-tech/compose-action@248470ecc5ed40d8ed3d4480d8260d77179ef579
        with:
          compose-file: utils/docker-compose.ci.yaml

      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            curl -f http://localhost:8000/health && exit 0
            sleep 5
          done
          echo "API did not become ready" && exit 1

      - name: Setup Node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version-file: e2e-test/playwrightTS/package.json
          cache: npm
          cache-dependency-path: e2e-test/playwrightTS/package-lock.json

      - name: Install task
        uses: supplypike/setup-bin@1fafb085795af4a3f183502f3a9dffa8f7b83217
        with:
          uri: https://github.com/go-task/task/releases/download/v3.46.4/task_linux_amd64.tar.gz
          name: task
          version: v3.46.4

      - name: Install dependencies
        working-directory: e2e-test/playwrightTS
        run: task install_dependencies_ci

      - name: Run Playwright tests
        working-directory: e2e-test/playwrightTS
        run: task run-tests
